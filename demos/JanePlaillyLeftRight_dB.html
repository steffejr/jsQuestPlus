<!-- 
What would simulations look like? 
Outcome measures:
- error between true and estimate
- SD
- distance between starting point and true threshold: 

Range of Stimuli
- 1 to 16

Independent measures
- number of trials: 5 - 50
- starting point: range of stimuli
- beta: 1,5,0.5 (steps)
- starting prior standarad deviation: range of stimuli

-->

<!DOCTYPE html>
<html>
    <head>
        
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="../dist/jsQuestPlus.js"></script>
    </head>
<body>
    Simulation based on the Hochenberger 2019 paper.
    <p>Please open the JavaScript console window in your browser. If you are using Chrome on Windows, press Ctrl + Shift + I to open the console.</p>
    <canvas id="myChart" style="width:100%;max-width:1000px;max-height:500px"></canvas>
    <canvas id="myChart02" style="width:100%;max-width:700px;max-height:200px"></canvas>
    <canvas id="myChart03" style="width:100%;max-width:700px;max-height:200px"></canvas>
    <canvas id="myChart04" style="width:100%;max-width:700px;max-height:200px"></canvas>
</body>


<script>
    
    function func_respYES(stim, threshold, slope, guess, lapse) {
        // return 1 - lapse - (1 - lapse - guess )*Math.exp(-Math.pow(stim/threshold,slope))
        // return 1 - ( 1 - guess )*Math.exp(Math.pow(-10, (slope/20)*(stim - threshold + lapse)))
        return 1 - lapse - (1-guess-lapse)*Math.exp(-(Math.pow(10,slope*(stim-threshold)/20)))
    }

    // Psychometric function corresponding to the second response (response = 1).
    function func_respNO(stim, threshold, slope, guess, lapse) {
        return 1 - func_respYES(stim, threshold, slope, guess, lapse) 
    }
    
    function simulate_resp2(current_intensity, true_threshold)
    {
        if ( current_intensity > true_threshold )
        { return 0}
        else { return 1 }
    }

    function simulate_resp(current_intensity, true_threshold, true_slope, true_guess, true_lapse){
        var currentProbYes = func_respYES(current_intensity, true_threshold, true_slope, true_guess, true_lapse)        
        // if current stimulus is below threshold, then guess at guess rate
        // if current stim is ABOVE threshold, then get it correct at prob of 
        
        // currentThresh value
        var RandomNumber = Math.random()
        //console.log('At intensity: '+ current_intensity +', Prob of YES: '+currentProbYes+', RandomNumber: '+RandomNumber)
        if (RandomNumber <  ( currentProbYes ))
        {
              return 1 // yes // 
          } else {
              return 0 // no // 
          }

      } 

    function FindClosestBottle(TestValue, threshold_samples)
    {
        // Find the value closest to the test value
        // Calculate the difference score
        // console.log("DIFFERENCE")
        var diff = threshold_samples.map(e => e-TestValue)
        // console.log(diff)
        // find the absolute value
        var absArr = diff.map(e => Math.abs(e))
        // console.log(absArr)
        // Find the minimum value
        minVal = Math.min(...absArr)
        // console.log(minVal)
        indexMinVal = absArr.indexOf(minVal)
        return indexMinVal
    }
      // 16 is the smallest concentration  
      // The psychometric function considers bigger as harder to detect. This is the
      // reverse of what the Sniffin Sticks are. For them, 16 is the highest concentration.
      // 1 is the largest concentration
      // We need to think in reverse, maps the stick numbers backwards.

    //const contrast_samples = [100,33,3,11,1,3,7,1,23,0.412,0.137,0.0457,0.0152,0.00508,0.00169]
    
    //var samples = jsQuestPlus.linspace(0,10,101)
    //samples[0] = 0.001
    
    
    /*for ( var i = 0; i < contrast_samples.length; i++ ) 
    { contrast_samples[i] = 100 - contrast_samples[i]}*/
    var threshold_samples = []
    threshold_samples.push(100,33.3,11.1,3.7,1.23,0.412,0.137,0.0457,0.0152,0.00508,0.00169)
    var threshold_samples_dB = threshold_samples.map(Math.log10)
    
    threshold_samples_dB = threshold_samples_dB.map(element => element*20)
    console.log("SAMPLES dB")
    console.log(threshold_samples)
    console.log(threshold_samples_dB)
    
    


    var samples = jsQuestPlus.linspace(threshold_samples_dB[0],threshold_samples_dB[10],101)
    //samples = threshold_samples_dB
    console.log(samples)


    const slope = [2.5] // Don't forget to add brackets, i.e., specify as an array.
    const guess = [0.5]
    const lapse = [0.01]
    

    var StartingGuess = -10
    const threshold_prior = jsQuestPlus.gauss(samples, StartingGuess, 20)

    const jsqp = new jsQuestPlus({
        psych_func:  [func_respNO, func_respYES], 
        stim_samples: [samples], // This is where the stimulus dimensions are defined
        psych_samples: [samples, slope, guess, lapse],
        //priors: [threshold_prior]
        priors: jsQuestPlus.set_prior([threshold_prior, slope.length, guess.length, lapse.length]),
    })
    
//console.log(jsqp.getStimParams())
    
    var RealThreshold = -10
    
    // Create plot of psychoresponse
    xyData = []
    
    for ( var i = 1; i < samples.length; i++ )
    { 
        xyData.push(func_respYES(samples[i], RealThreshold, slope[0], guess[0], lapse[0])) 
    }
    

    console.log('PSYCHOMETRIC RESPONSE')
    console.log(xyData)    
    new Chart("myChart", {
        type: "line",
        data: {
            labels: samples,
            datasets: [
                {
                    label: 'Left',
                    pointRadius: 4,
                    //pointBackgroundColor: "rgba(0,0,255,1)",
                    data: xyData
                }
            ]
        },
        options: {
            plugins: {legend: {display: true},
            title: {
                display: true,
                text: "Real: "+RealThreshold,
                fontSize: 16
            }},
            scales: {
                y: {
                    min: 0.0,
                    max: 1.02,
                    title: {
                        display: true,
                        text: "Probability of YES response"
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: "Bottle Number"
                    }
                }
            }
        } 
    });
   
    console.log("Starting Point")
    console.log(jsqp.getEstimates()[0])
    

    function WhichSideToStimulate(countLEFT, countRIGHT, NTrialsLEFT, NTrialsRIGHT) 
    {
        // Scenarios:
        // random number picks side
        // if count on left is finished, pick right
        // if count on right is finished, pick left
        // if both counts done, pick none
        // if both counts NOT done, randomly pick side
        var Side = ''
        var LeftFinishedFLAG = false
        var RightFinishedFLAG = false
        if ( countLEFT === NTrialsLEFT ) 
        { LeftFinishedFLAG = true }
        if ( countRIGHT === NTrialsRIGHT ) 
        { RightFinishedFLAG = true }
        
        if ( LeftFinishedFLAG && ( ! RightFinishedFLAG ) )
        { Side = 'RIGHT' }
        if ( ! LeftFinishedFLAG && ( RightFinishedFLAG ) )
        { Side = 'LEFT' }
        if ( LeftFinishedFLAG && ( RightFinishedFLAG ) )
        { Side = 'DONE' }

        if ( ! LeftFinishedFLAG && ( ! RightFinishedFLAG ) )
        { 
            var RandomNumber = Math.random()
            if ( RandomNumber < 0.5 )
            { Side = 'LEFT' }
            else 
            { Side = 'RIGHT' }
        }
        return Side
    }
    
    
    var simDataYLEFT = []
    var simDataNLEFT = []
    var simDataYRIGHT = []
    var simDataNRIGHT = []

    var xDataYLEFT = []
    var xDataNLEFT = []
    var xDataYRIGHT = []
    var xDataNRIGHT = []

    var sdDataLEFT = []
    var sdDataRIGHT = []    
    var NTrialsLEFT = 20
    var NTrialsRIGHT = 20
    var NTrials = NTrialsLEFT + NTrialsRIGHT
    var countLEFT = 0 
    var countRIGHT = 0
    var Side 
    for ( var i = 0; i < NTrials; i++ )
    { 
    //  Is this Left or Right?
        Side = WhichSideToStimulate(countLEFT, countRIGHT, NTrialsLEFT, NTrialsRIGHT) 
        console.log(Side)
        switch ( Side ) {
            case 'LEFT':
                SimResponse = simulate_resp(jsqp.getStimParams(), RealThreshold, slope[0], guess[0], lapse[0])
                if ( SimResponse == 1 )
                { 
                    xDataYLEFT.push(i) 
                    simDataYLEFT.push(jsqp.getStimParams()) 
                }
                if ( SimResponse == 0 )
                { 
                    xDataNLEFT.push(i) 
                    simDataNLEFT.push(jsqp.getStimParams()) 
                }
                sdDataLEFT.push(jsqp.getSDs()[0])
                CurrentStim = (jsqp.getStimParams())
                console.log("CURRENT STIM IS: "+CurrentStim)
                console.log("CLOSEST BOTTLE: "+threshold_samples_dB[FindClosestBottle(CurrentStim, threshold_samples_dB)])

                // jsqp.update(CurrentStim, SimResponse)
                jsqp.update(threshold_samples_dB[FindClosestBottle(CurrentStim, threshold_samples_dB)], SimResponse)
                break;
            case 'RIGHT':
                SimResponse = simulate_resp(jsqp.getStimParams(), RealThreshold, slope[0], guess[0], lapse[0])
                if ( SimResponse == 1 )
                { 
                    xDataYRIGHT.push(i) 
                    simDataYRIGHT.push(jsqp.getStimParams()) 
                }
                if ( SimResponse == 0 )
                { 
                    xDataNRIGHT.push(i) 
                    simDataNRIGHT.push(jsqp.getStimParams()) 
                }
                sdDataRIGHT.push(jsqp.getSDs()[0])

                CurrentStim = (jsqp.getStimParams())
                jsqp.update(CurrentStim, SimResponse)
                break;
            case 'DONE':
                break;
        }
    }
    console.log(jsqp)
    console.log(xDataYRIGHT)
    console.log(jsqp.getEstimates()[0])
    console.log(Math.pow(10,jsqp.getEstimates()[0]/20))
    console.log(Math.pow(10,0/20))
       
    new Chart("myChart02", {
        type: "scatter",
        data: {
            
            datasets: [
            {
                pointRadius: 4,
                //pointBackgroundColor: "rgba(0,0,255,1)",
                borderColor: "red",
                fill: true,
                fillColor: "red",
                pointStyle: 'rectRot',
                data: simDataNLEFT.map((v,i) => ({ x: xDataNLEFT[i], y: v }))
            },
            {
                pointRadius: 4,
                //pointBackgroundColor: "rgba(0,0,255,1)",
                borderColor: "green",
                fill: true,
                pointStyle: 'rectRot',
                data: simDataYLEFT.map((v,i) => ({ x: xDataYLEFT[i], y: v }))
            },
            {
                pointRadius: 4,
                //pointBackgroundColor: "rgba(0,0,255,1)",
                borderColor: "red",
                fill: true,
                fillColor: "red",
                pointStyle: 'circle',
                data: simDataNRIGHT.map((v,i) => ({ x: xDataNRIGHT[i], y: v }))
            },
            {
                pointRadius: 4,
                //pointBackgroundColor: "rgba(0,0,255,1)",
                borderColor: "green",
                fill: true,
                pointStyle: 'circle',
                data: simDataYRIGHT.map((v,i) => ({ x: xDataYRIGHT[i], y: v }))
            }
        ]
        },
        options: {
            plugins: {legend: {display: false},
            title: {
                display: true,
                text: "Trial Yes/No responses to get to the real threshold of: "+RealThreshold+" Est Thresh: "+jsqp.getEstimates()[0] ,
                fontSize: 16
            }},
            scales: {
                y: {
                    min: -40,
                    max: 40,
                    title: {
                        display: true,
                        text: "Bottle Number"
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: "Trial Number"
                    }
                }
            }
        } 
    });
    /*
    console.log(jsqp)
    var stim_params = jsqp.stim_params[0]
    postPrior = jsqp.posteriors.normalized_priors
    //postPrior = jsqp.posteriors.priors[0]
    postData = []
    for ( var i = 0; i < postPrior.length; i++ )
    { postData.push({x:stim_params[i], y: postPrior[i]})}
    new Chart("myChart03", {
        type: "scatter",
        data: {
            datasets: [{
            pointRadius: 4,
            pointBackgroundColor: "rgba(0,0,255,1)",
            data: postData
            }]
        },
        options: {
            plugins: {legend: {display: false},
        
        title: {
                display: true,
                text: "Posterior Probability",
                fontSize: 16
            }},
            scales: {
                x: {
                    title: {
                        display: true,
                        text: "Bottle Number"
                    }
                }
            }
        
    }
    })

    var sdDataXY = []
    for ( var i = 0; i < sdData.length; i++ )
    { sdDataXY.push({x:i, y: sdData[i]})}
    console.log(sdDataXY)
    new Chart("myChart04", {
        type: "scatter",
        data: {
            datasets: [{
            pointRadius: 4,
            pointBackgroundColor: "rgba(0,0,255,1)",
            data: sdDataXY
            }]
        },
options: {
            plugins: {legend: {display: false},
        
        title: {
                display: true,
                text: "Standard Deviation",
                fontSize: 16
            }},
            scales: {
                x: {
                    title: {
                        display: true,
                        text: "Trial Number"
                    }
                }
            }
        
    }
    })
console.log(jsqp)    
console.log(jsqp.getEstimates())    
console.log(jsqp.getSDs())    
console.log(jsqp.getStimParams())    
var error = RealThreshold - jsqp.getEstimates()[0]
console.log(error)

*/
</script>