<!DOCTYPE html>
<html>
    <head>
        
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="../dist/jsQuestPlus.js"></script>
    </head>
<body>
    Simulation based on the Hochenberger 2019 paper.
    <p>Please open the JavaScript console window in your browser. If you are using Chrome on Windows, press Ctrl + Shift + I to open the console.</p>
    <canvas id="myChart" style="width:100%;max-width:700px;max-height:200px"></canvas>
    <canvas id="myChart02" style="width:100%;max-width:700px;max-height:200px"></canvas>
    <canvas id="myChart04" style="width:100%;max-width:700px;max-height:200px"></canvas>
    <canvas id="myChart03" style="width:100%;max-width:700px;max-height:500px"></canvas>
</body>
<script>
    
    function func_resp0(stim, threshold, slope, guess, lapse) {
        return 1 - lapse - (1 - guess - lapse )*Math.exp(-Math.pow(stim/threshold,slope))
        //return lapse*guess+(1-lapse)*(1-(1-guess)*Math.exp(-10*Math.pow(slope*(stim+threshold))))
    }

    // Psychometric function corresponding to the second response (response = 1).
    function func_resp1(stim, threshold, slope, guess, lapse) {
        return 1 - func_resp0(stim, threshold, slope, guess, lapse) 
    }
    
    
    function simulate_resp(current_intensity, true_threshold, true_slope, true_guess, true_lapse){
        var currentThresh = func_resp0(current_intensity, true_threshold, true_slope, true_guess, true_lapse)        
        // if current stimulus is below threshold, then guess at guess rate
        // if current stim is ABOVE threshold, then get it correct at prob of 
        // currentThresh value
        if (Math.random() >  ( 1 - currentThresh ))
        {
              return 0 // yes
          } else {
              return 1 // no
          }

      } 

      // 16 is the smallest concentration  
      // The psychometric function considers bigger as harder to detect. This is the
      // reverse of what the Sniffin Sticks are. For them, 16 is the highest concentration.
      // 1 is the largest concentration
      // We need to think in reverse, maps the stick numbers backwards.

    const contrast_samples = jsQuestPlus.linspace(1,9,100)
    const threshold_samples = jsQuestPlus.linspace(1,9,100) // [-40, -39, -38, ..., -1, 0]
    const slope = [3.5] // Don't forget to add brackets, i.e., specify as an array.
    const guess = [0.5]
    const lapse = [0.05]
    
    const threshold_prior = jsQuestPlus.gauss(threshold_samples, 6, 20)

    console.log(threshold_prior)
    const jsqp = new jsQuestPlus({
        psych_func:  [func_resp0, func_resp1], 
        stim_samples: [contrast_samples], 
        psych_samples: [threshold_samples, slope, guess, lapse],
        //priors: [threshold_prior]
        priors: jsQuestPlus.set_prior([threshold_prior, slope.length, guess.length, lapse.length]),
    })

    var RealThreshold = 7
    var NTrials = 40
    xyData = []
    for ( var i = 1; i < 10; i++ )
    { xyData.push({x:i,y:func_resp0(i, RealThreshold, slope[0], guess, lapse)}) }
    

    

    new Chart("myChart", {
        type: "scatter",
        data: {
            datasets: [{
            pointRadius: 4,
            pointBackgroundColor: "rgba(0,0,255,1)",
            data: xyData
            }]
        },
        options: {
            plugins: {legend: {display: false},
            title: {
                display: true,
                text: "The Psychometric function with a TRUE threshold of "+RealThreshold,
                fontSize: 16
            }}
        } 
    });
   
    console.log("Starting Point")
    console.log(jsqp.getEstimates()[0])
    var simDataY = []
    var simDataN = []
    var xDataY = []
    var xDataN = []
    var SDdata = []
    for ( var i = 0; i < NTrials; i++ )
    { 
        SDdata.push(jsqp.getSDs()[0])
        SimResponse = simulate_resp(jsqp.getStimParams(), RealThreshold, slope[0], guess, lapse)
        //simData.push({x:i, y:func_resp0(jsqp.getStimParams(), RealThreshold, slope, guess, lapse)})
        if ( SimResponse == 0 )
        { 
            xDataN.push(i)
            simDataN.push(jsqp.getEstimates()[0]) 
        }
        else { 
            xDataY.push(i)
            simDataY.push(jsqp.getEstimates()[0]) 
        }
        jsqp.update(jsqp.getStimParams(), SimResponse)
    }
    console.log(jsqp.getEstimates())
    console.log(jsqp.getSDs())
    
    new Chart("myChart02", {
        type: "scatter",
        data: {
            
            datasets: [{
                pointRadius: 4,
                //pointBackgroundColor: "rgba(0,0,255,1)",
                borderColor: "red",
                fill: true,
                fillColor: "red",
                data: simDataN.map((v,i) => ({ x: xDataN[i], y: v }))
            },
            {
                pointRadius: 4,
                //pointBackgroundColor: "rgba(0,0,255,1)",
                borderColor: "green",
                fill: true,
                data: simDataY.map((v,i) => ({ x: xDataY[i], y: v }))
            }
        ]
        },
        options: {
            plugins: {legend: {display: false},
            title: {
                display: true,
                text: "Trial Yes/No responses to get to the real threshold of: "+RealThreshold+" Est Thresh: "+jsqp.getEstimates()[0] ,
                fontSize: 16
            }},
            scales: {
                y: {
                    min: 0,
                    max: 10,
                    title: {
                        display: true,
                        text: "Stick Number"
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: "Trial Number"
                    }
                }
            }
        } 
    });

    new Chart("myChart04", {
        type: "scatter",
        data: {
            
            datasets: [{
                pointRadius: 4,
                //pointBackgroundColor: "rgba(0,0,255,1)",
                borderColor: "red",
                fill: true,
                fillColor: "red",
                data: SDdata.map((v,i) => ({ x: xDataN[i], y: v }))
            },
            {
                pointRadius: 4,
                //pointBackgroundColor: "rgba(0,0,255,1)",
                borderColor: "green",
                fill: true,
                data: SDdata.map((v,i) => ({ x: xDataY[i], y: v }))
            }
        ]
        },
        options: {
            plugins: {legend: {display: false},
            title: {
                display: true,
                text: "Trial Yes/No responses to get to the real threshold of: "+RealThreshold+" Est Thresh: "+jsqp.getEstimates()[0] ,
                fontSize: 16
            }},
            scales: {d 
                y: {
                    title: {
                        display: true,
                        text: "Standard Deviation"
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: "Trial Number"
                    }
                }
            }
        } 
    });
    console.log(jsqp)
    var stim_params = jsqp.stim_params[0]
    postPrior = jsqp.posteriors.normalized_priors
    //postPrior = jsqp.posteriors.priors[0]
    postData = []
    for ( var i = 0; i < postPrior.length; i++ )
    { postData.push({x:stim_params[i], y: postPrior[i]})}
    new Chart("myChart03", {
        type: "scatter",
        data: {
            datasets: [{
            pointRadius: 4,
            pointBackgroundColor: "rgba(0,0,255,1)",
            data: postData
            }]
        }
    })
console.log(jsqp)    
console.log(jsqp.getEstimates())    
console.log(jsqp.getSDs())    
console.log(jsqp.getStimParams())    
var error = RealThreshold - jsqp.getEstimates()[0]
console.log(error)
</script>