<!-- 
What would simulations look like? 
Outcome measures:
- error between true and estimate
- SD
- distance between starting point and true threshold: 

Range of Stimuli
- 1 to 16

Independent measures
- number of trials: 5 - 50
- starting point: range of stimuli
- beta: 1,5,0.5 (steps)
- starting prior standarad deviation: range of stimuli

-->

<!DOCTYPE html>
<html>
    <head>
        
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="../dist/jsQuestPlus.js"></script>
    </head>
<body>
    Simulation based on the Hochenberger 2019 paper.
    <p>Please open the JavaScript console window in your browser. If you are using Chrome on Windows, press Ctrl + Shift + I to open the console.</p>
    <canvas id="myChart" style="width:100%;max-width:700px;max-height:200px"></canvas>
    <canvas id="myChart02" style="width:100%;max-width:700px;max-height:200px"></canvas>
    <canvas id="myChart03" style="width:100%;max-width:700px;max-height:200px"></canvas>
    <canvas id="myChart04" style="width:100%;max-width:700px;max-height:200px"></canvas>
</body>


<script>
    
    function func_respYES(stim, threshold, slope, guess, lapse) {
        
        //return 1 - lapse - (1 - guess - lapse )*Math.exp(-Math.pow(stim/threshold,slope))
        return guess + (1 - guess - lapse )*Math.exp(-Math.pow(stim/threshold,slope))
        //return lapse*guess+(1-lapse)*(1-(1-guess)*Math.exp(-10*Math.pow(slope*(stim+threshold))))
    }

    // Psychometric function corresponding to the second response (response = 1).
    function func_respNO(stim, threshold, slope, guess, lapse) {
        return 1 - func_respYES(stim, threshold, slope, guess, lapse) 
    }
    
    function simulate_resp2(current_intensity, true_threshold)
    {
        if ( current_intensity < true_threshold )
        { return 0}
        else { return 1 }
    }

    function simulate_resp(current_intensity, true_threshold, true_slope, true_guess, true_lapse){
        var currentProbYes = func_respYES(current_intensity, true_threshold, true_slope, true_guess, true_lapse)        
        // if current stimulus is below threshold, then guess at guess rate
        // if current stim is ABOVE threshold, then get it correct at prob of 
        
        // currentThresh value
        var RandomNumber = Math.random()
        console.log('At intensity: '+ current_intensity +', Prob of YES: '+currentProbYes+', RandomNumber: '+RandomNumber)
        if (RandomNumber <  ( currentProbYes ))
        {
              return 0 // yes // This is super confusing. The ZERO means the first psychometric function provided to the algorithm.
              // If you look at where the new jsQuestPlus was created the first function is the YES and the second is the NO
          } else {
              return 1 // no // 
          }

      } 

      // 16 is the smallest concentration  
      // The psychometric function considers bigger as harder to detect. This is the
      // reverse of what the Sniffin Sticks are. For them, 16 is the highest concentration.
      // 1 is the largest concentration
      // We need to think in reverse, maps the stick numbers backwards.

    //const contrast_samples = [100,33,3,11,1,3,7,1,23,0.412,0.137,0.0457,0.0152,0.00508,0.00169]
    var contrast_samples = jsQuestPlus.linspace(0,10,101)
    
    contrast_samples[0] = 0.001
    
    /*for ( var i = 0; i < contrast_samples.length; i++ ) 
    { contrast_samples[i] = 100 - contrast_samples[i]}*/
    
    const threshold_samples = contrast_samples//[100,33,3,11,1,3,7,1,23,0.412,0.137,0.0457,0.0152,0.00508,0.00169]
    const slope = [3.5] // Don't forget to add brackets, i.e., specify as an array.
    const guess = [0.5]
    const lapse = [0.01]
    

    var StartingGuess = 5.5
    const threshold_prior = jsQuestPlus.gauss(threshold_samples, StartingGuess, 20)

    const jsqp = new jsQuestPlus({
        psych_func:  [func_respYES, func_respNO], 
        stim_samples: [contrast_samples], 
        psych_samples: [threshold_samples, slope, guess, lapse],
        //priors: [threshold_prior]
        priors: jsQuestPlus.set_prior([threshold_prior, slope.length, guess.length, lapse.length]),
    })


    
    var RealThreshold = 7
    var NTrials = 40
    // Create plot of psychoresponse
    xyData = []
    for ( var i = 1; i < contrast_samples.length; i++ )
    { 
        xyData.push({x:contrast_samples[i],y:func_respYES(contrast_samples[i], RealThreshold, slope[0], guess[0], lapse[0])}) 
    }
    

    console.log('PSYCHOMETRIC RESPONSE')
    console.log(xyData)
    new Chart("myChart", {
        type: "scatter",
        data: {
            datasets: [{
            pointRadius: 4,
            pointBackgroundColor: "rgba(0,0,255,1)",
            data: xyData
            }]
        },
        options: {
            plugins: {legend: {display: false},
            title: {
                display: true,
                text: "Trial Yes/No responses to get to the real threshold of: "+RealThreshold,
                fontSize: 16
            }},
            scales: {
                y: {
                    min: 0.0,
                    max: 1.02,
                    title: {
                        display: true,
                        text: "Probability of YES response"
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: "Bottle Number"
                    }
                }
            }
        } 
    });
   
    console.log("Starting Point")
    console.log(jsqp.getEstimates()[0])
    console.log(jsqp.getStimParams())
    var simDataY = []
    var simDataN = []
    var xDataY = []
    var xDataN = []
    var sdData = []
    for ( var i = 0; i < NTrials; i++ )
    { 
      
        SimResponse = simulate_resp2(jsqp.getEstimates()[0], RealThreshold, slope[0], guess[0], lapse[0])
        
        //simData.push({x:i, y:func_resp0(jsqp.getStimParams(), RealThreshold, slope, guess, lapse)})
        if ( SimResponse == 0 ) // This is a YES response
        { 
            xDataY.push(i)
            simDataY.push(jsqp.getEstimates()[0]) 
        }
        else { 
            xDataN.push(i)
            simDataN.push(jsqp.getEstimates()[0]) 
        }
        sdData.push(jsqp.getSDs()[0])
        //console.log(Math.round(jsqp.getStimParams()))
        // round these to the nearest integer
        CurrentStim = (jsqp.getStimParams())
        
        CurrentStim = Math.round(CurrentStim)
        if ( SimResponse == 0)
            {console.log('Trial: '+i+', Stim: '+CurrentStim+', Response: '+'YES') } 
        else {{console.log('Trial: '+i+', Stim: '+CurrentStim+', Response: '+'NO') } }
        jsqp.update(CurrentStim, SimResponse)
    }
    console.log("FINAL PARAMETERS")
    console.log(jsqp.getEstimates())
    console.log(jsqp.getStimParams())
    console.log(jsqp.getSDs())
    console.log(sdData)
    new Chart("myChart02", {
        type: "scatter",
        data: {
            
            datasets: [{
                pointRadius: 4,
                //pointBackgroundColor: "rgba(0,0,255,1)",
                borderColor: "red",
                fill: true,
                fillColor: "red",
                data: simDataN.map((v,i) => ({ x: xDataN[i], y: v }))
            },
            {
                pointRadius: 4,
                //pointBackgroundColor: "rgba(0,0,255,1)",
                borderColor: "green",
                fill: true,
                data: simDataY.map((v,i) => ({ x: xDataY[i], y: v }))
            }
        ]
        },
        options: {
            plugins: {legend: {display: false},
            title: {
                display: true,
                text: "Trial Yes/No responses to get to the real threshold of: "+RealThreshold+" Est Thresh: "+jsqp.getEstimates()[0] ,
                fontSize: 16
            }},
            scales: {
                y: {
                    min: 0,
                    max: 12,
                    title: {
                        display: true,
                        text: "Bottle Number"
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: "Trial Number"
                    }
                }
            }
        } 
    });
    console.log(jsqp)
    var stim_params = jsqp.stim_params[0]
    postPrior = jsqp.posteriors.normalized_priors
    //postPrior = jsqp.posteriors.priors[0]
    postData = []
    for ( var i = 0; i < postPrior.length; i++ )
    { postData.push({x:stim_params[i], y: postPrior[i]})}
    new Chart("myChart03", {
        type: "scatter",
        data: {
            datasets: [{
            pointRadius: 4,
            pointBackgroundColor: "rgba(0,0,255,1)",
            data: postData
            }]
        },
        options: {
            plugins: {legend: {display: false},
        
        title: {
                display: true,
                text: "Posterior Probability",
                fontSize: 16
            }},
            scales: {
                x: {
                    title: {
                        display: true,
                        text: "Bottle Number"
                    }
                }
            }
        
    }
    })

    var sdDataXY = []
    for ( var i = 0; i < sdData.length; i++ )
    { sdDataXY.push({x:i, y: sdData[i]})}
    console.log(sdDataXY)
    new Chart("myChart04", {
        type: "scatter",
        data: {
            datasets: [{
            pointRadius: 4,
            pointBackgroundColor: "rgba(0,0,255,1)",
            data: sdDataXY
            }]
        },
options: {
            plugins: {legend: {display: false},
        
        title: {
                display: true,
                text: "Standard Deviation",
                fontSize: 16
            }},
            scales: {
                x: {
                    title: {
                        display: true,
                        text: "Trial Number"
                    }
                }
            }
        
    }
    })
console.log(jsqp)    
console.log(jsqp.getEstimates())    
console.log(jsqp.getSDs())    
console.log(jsqp.getStimParams())    
var error = RealThreshold - jsqp.getEstimates()[0]
console.log(error)


</script>