
<!--
- Spatial odor localization thresholds (the one I'm interested in):

This test also involves a set of vials, all containing the same odor but at different concentrations. The aim is to determine the lowest concentration at which the participant is able to tell which nostril is being stimulated by an odor. In each trial, two vials are presented to the participant simultaneously. One is placed under the right nostril and the other under the left nostril. One contains a scent and the other does not. The participant must then say which nostril the scent was presented in. They must say whether it was the right or the left. Depending on their answer, we determine whether their answer is correct or not. Depending on the accuracy of the answer, they are then presented with a vial with a same, lower or higher concentration. For this test, the order in which the right or left nostril is stimulated with the scented vial is random (the other vial is always an odorless vial). This is therefore information that the experimenter must know, in addition to the number of the vial to be used.

 

I'm not familiar with the quest method, but for the staircase method, the rules for moving from one concentration to another are strict: you start with the lowest concentration. Then, if the answer is negative, you present the bottle with not the concentration just above, but the one above that. And so on until the participant has two correct answers in a row. When they have two correct answers in a row, you take the bottle with the lower concentration and continue until they give an incorrect answer (only one incorrect answer is required). Then take the bottle with the concentration just above it, and so on until the participant gets two correct answers. Continue until the change in concentration direction (moving towards higher or lower concentrations) has occurred six times. The threshold is determined by averaging the last four concentrations at which the change in direction occurred.

I attached an example to this email. Ia have also found a pdf describing the detection threshold test using staircase method with the sniffin sticks devices, it could help

 

-->
<!DOCTYPE html>
<html>
  <head>
    <script src="../dist/jsQuestPlus.js"></script>
    <script src="../src/jspsych.js"></script>
    <script src="../src/plugin-html-button-response.js"></script>
    <script src="../src/plugin-html-keyboard-response.js"></script>
    <script src="../dist/jsQuestPlus.js"></script>
    <link rel="stylesheet" href="../src/jspsych.css">
  </head>
  <body></body>
  <script>
    const jsPsych = initJsPsych()
    console.log(`jsPsych Version ${jsPsych.version()}`)

    const instruction = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `<p>This program demonstrates how to use jsQuestPlus  </p>`,
        choices: ['START']
    }
    
    // Psychometric function corresponding to the first response (response = 0).
    function func_respYES(stim, threshold, slope, guess, lapse) {
        return 1 - lapse - (1 - lapse - guess )*Math.exp(-Math.pow(stim/threshold,slope))
    }

    // Psychometric function corresponding to the second response (response = 1).
    function func_respNO(stim, threshold, slope, guess, lapse) {
        return 1 - func_respYES(stim, threshold, slope, guess, lapse) 
    }
    // Which nostril to stimulate. 
    // This is a random choice except where one side or the other has "completed"
    // all of its trials
    function WhichSideToStimulate(countLEFT, countRIGHT, NTrialsLEFT, NTrialsRIGHT, PrevRun, RunLimit) 
        {
            // Scenarios:
            // random number picks side
            // if count on left is finished, pick right
            // if count on right is finished, pick left
            // if both counts done, pick none
            // if both counts NOT done, randomly pick side
            var Side = ''
            var LeftFinishedFLAG = false
            var RightFinishedFLAG = false
            if ( countLEFT === NTrialsLEFT ) 
            { LeftFinishedFLAG = true }
            if ( countRIGHT === NTrialsRIGHT ) 
            { RightFinishedFLAG = true }
            
            if ( LeftFinishedFLAG && ( ! RightFinishedFLAG ) )
            { Side = 'RIGHT' }
            if ( ! LeftFinishedFLAG && ( RightFinishedFLAG ) )
            { Side = 'LEFT' }
            if ( LeftFinishedFLAG && ( RightFinishedFLAG ) )
            { Side = 'DONE' }

            if ( ! LeftFinishedFLAG && ( ! RightFinishedFLAG ) )
            { 
                var RandomNumber = Math.random()
                if ( RandomNumber < 0.5 )
                { Side = 'LEFT' }
                else 
                { Side = 'RIGHT' }
            }
            // Check for runs
            PrevRun.push(Side)
            var CurrentRun = 1
            for ( i = PrevRun.length - 1; i >= 0; i--)
            {
                if ( i > 0 )
                {
                    if (PrevRun[i] == PrevRun[ i - 1 ])
                    { CurrentRun++ }
                    else {
                        break
                    }
                }
            }           
            if ( CurrentRun > RunLimit )
            {
                if ( Side == "LEFT" ){ Side = "RIGHT"}
                else if ( Side == "RIGHT" ){ Side = "LEFT"}
                console.log('RUN LIMIT REACHED, SWITCHING SIDES')
            }
            // If the side is switched, make sure to update the run list
            PrevRun[PrevRun.length-1] = Side
            console.log("CURRENT RUN IS: "+CurrentRun)   
              
            
            // update counters
            if ( Side == 'LEFT' ){ countLEFT = countLEFT + 1 }
            if ( Side == 'RIGHT' ){ countRIGHT = countRIGHT + 1 }
            
            return Side
        }
    
    // Specifiy the space of all possible stimuli
    // The 101 is the number of values to split the span of 0 to 10 into.
    // 101 ensures that integrer values exist
    var samples = jsQuestPlus.linspace(0,10,101)
    // For some reason the psychometric function does not like zero so this is changed to almost zero
    samples[0] = 0.001        
    
    const threshold_samples = samples

    // Map the bottles
    // The staircase is assuming that the higher numbers mean easier to detect
    // and that smaller means harder to detect.
    // Therefore, map the staircase stim to the bottle number.
    function MapStimToBottleNumber(stim)
    {
        return Math.abs(stim - 10)
    }

    const slope = [3.5] // Don't forget to add brackets, i.e., specify as an array.
    // There is a 50% chance of being correct. The guess rate is therefore 0.5
    const guess = [0.5]
    // The rate of randomly being wrong, the lapse rate
    const lapse = [0.01]
    
    // Specify the starting information. This is the a priori information    
    var StartingGuess = 5.5
    var StartingStandardDeviation = 20
    const threshold_prior = jsQuestPlus.gauss(threshold_samples, StartingGuess, StartingStandardDeviation)

    // Specify the Quest
        const jsqp = new jsQuestPlus({
        psych_func:  [func_respNO, func_respYES], 
        stim_samples: [samples], 
        psych_samples: [threshold_samples, slope, guess, lapse],
        //priors: [threshold_prior]
        priors: jsQuestPlus.set_prior([threshold_prior, slope.length, guess.length, lapse.length]),
    })

    var NTrialsLEFT = 10
    var NTrialsRIGHT = 10
    var NTrials = NTrialsLEFT + NTrialsRIGHT
    var countLEFT = 0 
    var countRIGHT = 0
    var Side 
    var PrevRun = []
    var RunLimit = 3
    var Accuracy = -99
    let trial_num = 1
    
    let BottleNum = -99
    const trial = {
        type: jsPsychHtmlButtonResponse,
        stimulus: function(){
            // Get the stimulus/bottle to present
            stim = jsqp.getStimParams()
            BottleNum = Math.round(MapStimToBottleNumber(stim))
            console.log("Bottle NUM: " + BottleNum)
            // Get which nostril to present to
            Side = WhichSideToStimulate(countLEFT, countRIGHT, NTrialsLEFT, NTrialsRIGHT, PrevRun, RunLimit) 
            console.log(PrevRun)
            // update counters
            if ( Side == 'LEFT' ){ countLEFT = countLEFT + 1 }
            if ( Side == 'RIGHT' ){ countRIGHT = countRIGHT + 1 }

            console.log('Estimates: ')
            console.log(jsqp.getEstimates())
            // Return the stimulus with the parameters suggested by jsQuestPlus.
            return `<p>Simulation trial = ${trial_num}/${NTrials}</p>
                <p>Bottle Number = ${BottleNum}</p>
                <p>Nostril: ${Side}</p>`
            },
            choices: ['Left', 'Right'],
            on_finish(data){
                console.log("RESPONSE")
                console.log(data.response)
                // Left (First choice) is a zero
                // Right (Second choice) is a one
                // Check to see if the response is corect or not
                if (( Side == 'LEFT' ) && (data.response == 0 ))
                { 
                    console.log("CORRECT") 
                    Accuracy = 1
                }
                else if (( Side == 'RIGHT' ) && (data.response == 1 ))
                { 
                    console.log("CORRECT") 
                    Accuracy = 1
                }
                else 
                { 
                    console.log("IN--CORRECT")
                    Accuracy = 0
                }
                data.TrialType = 'STIM'
                data.Accuracy = Accuracy
                data.Nostril = Side
                data.BottleNumber = BottleNum
                data.sd = jsqp.getSDs()[0]
                data.Estimate = MapStimToBottleNumber(jsqp.getEstimates()[0])
                jsqp.update(stim, Accuracy)
            }
    }

    const loop_node = {
        timeline: [trial],
        loop_function: function(data){
            if (trial_num < NTrials){
                trial_num++
                return true
            } else {
                return false
            }
        }
    }

    const briefing = {
        type: jsPsychHtmlButtonResponse,
        stimulus: function(){
            const estimates = jsqp.getEstimates()
            console.log(estimates)
            data = jsPsych.data.get().filter({TrialType: 'STIM'})
            console.log(data)
            var Str = '<table border=1px><tr>'
                Str += '<td>Trial</td>'
                Str += '<td>Bottle</td>'
                Str += '<td>Nostril</td>'
                Str += '<td>Acc</td>'
                Str += '<td>RT</td>'
                Str += '<td>Standard Dev</td>'
                Str += '<td>Estimate</td>'
                Str += '</tr>'
                for ( var i = 0; i < NTrials; i++ )
                {
                    Str += '<tr>'
                    Str += '<td>'+data.trials[i].trial_index+'</td>'
                    Str += '<td>'+data.trials[i].BottleNumber+'</td>'
                    Str += '<td>'+data.trials[i].Nostril+'</td>'
                    Str += '<td>'+data.trials[i].Accuracy+'</td>'
                    Str += '<td>'+data.trials[i].rt+'</td>'
                    Str += '<td>'+data.trials[i].sd.toFixed(2)+'</td>'
                    Str += '<td>'+data.trials[i].Estimate.toFixed(2)+'</td>'
                    Str += '</tr>'
                }
                '</table>'
            return `<p>Final threshold estimate is ${MapStimToBottleNumber(estimates[0].toFixed(2))}.</p>`+Str

        },
        choices: ['Finish']
    }

    jsPsych.run([instruction, loop_node, briefing])

  </script>
</html>