<!DOCTYPE html>
<html>
    <head>
        
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src='https://cdn.plot.ly/plotly-3.3.0.min.js'></script>
        <script src="../dist/jsQuestPlus.js"></script>
    </head>
<body>
    Simulation based on the Hochenberger 2019 paper.
    	<div id='myDiv'></div>
</body>
<script>
    
    function func_respYES(stim, threshold, slope, guess, lapse) {
        return 1 - lapse - (1 - lapse - guess )*Math.exp(-Math.pow(stim/threshold,slope))
    }

    // Psychometric function corresponding to the second response (response = 1).
    function func_respNO(stim, threshold, slope, guess, lapse) {
        return 1 - func_respYES(stim, threshold, slope, guess, lapse) 
    }
    
    
    function simulate_resp(current_intensity, true_threshold, true_slope, true_guess, true_lapse){
    var currentProbYes = func_respYES(current_intensity, true_threshold, true_slope, true_guess, true_lapse)        
    // if current stimulus is below threshold, then guess at guess rate
    // if current stim is ABOVE threshold, then get it correct at prob of 
    // currentThresh value
    var RandomNumber = Math.random()
    //console.log('At intensity: '+ current_intensity +', Prob of YES: '+currentProbYes+', RandomNumber: '+RandomNumber)
    if (RandomNumber <  ( currentProbYes ))
    {
            return 1 // yes // 
        } else {
            return 0 // no // 
        }
    } 

      // 16 is the smallest concentration  
      // The psychometric function considers bigger as harder to detect. This is the
      // reverse of what the Sniffin Sticks are. For them, 16 is the highest concentration.
      // 1 is the largest concentration
      // We need to think in reverse, maps the stick numbers backwards.

    var samples = jsQuestPlus.linspace(0,10,101)
    samples[0] = 0.001
    
    /*for ( var i = 0; i < contrast_samples.length; i++ ) 
    { contrast_samples[i] = 100 - contrast_samples[i]}*/
    
    const threshold_samples = samples//[100,33,3,11,1,3,7,1,23,0.412,0.137,0.0457,0.0152,0.00508,0.00169]
    const slope = [3.5] // Don't forget to add brackets, i.e., specify as an array.
    const guess = [0.5]
    const lapse = [0.01]
    

    var StartingGuess = 5.5
    const threshold_prior = jsQuestPlus.gauss(threshold_samples, StartingGuess, 20)

    const jsqp = new jsQuestPlus({
        psych_func:  [func_respNO, func_respYES], 
        stim_samples: [samples], // This is where the stimulus dimensions are defined
        psych_samples: [threshold_samples, slope, guess, lapse],
        //priors: [threshold_prior]
        priors: jsQuestPlus.set_prior([threshold_prior, slope.length, guess.length, lapse.length]),
    })
    
    var NSim = 400
    var RealThreshold = 8
    var NTrials = 10
    var error = []
    var simSD = []
    const t0 = performance.now()
    
    for ( var k = 0; k < NSim; k++ )
    {
        CURRENTjsqp = jsqp
        for ( var i = 0; i < NTrials; i++ )
        {         
            SimResponse = simulate_resp(CURRENTjsqp.getStimParams(), RealThreshold, slope, guess, lapse)
            
            CURRENTjsqp.update(CURRENTjsqp.getStimParams(), SimResponse)
        }
        error.push(CURRENTjsqp.getEstimates()[0]-RealThreshold)
        simSD.push(CURRENTjsqp.getSDs()[0])
    }
    const t1 = performance.now()
    console.log(`Elapsed time: ${t1-t0}`)
    console.log(error)
    var trace = {
        x: error,
        type: 'histogram',
    }
    var data = [trace]
    Plotly.newPlot('myDiv', data);
</script>